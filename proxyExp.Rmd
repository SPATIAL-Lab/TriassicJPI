---
title: "Proxy Exploration"
author: "Gabriel Bowen"
date: "2024-12-19"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)

knitr::opts_chunk$set(echo = TRUE)

source("code/prepData.R")
load("bigout/post.rda")

pm = post$BUGSoutput$median

col.c = rgb(1, 0.2, 0.6)
col.a = rgb(0.2, 0.6, 1)

knitr::opts_knit$set(global.par = TRUE)

```

```{r setpar, include=FALSE}

par(mar = c(5, 5, 4, 1))

```

Let's review the high-latitude (terrestrial) proxy data and its interpretation. 
I'll refer to the sites by number for convenience, here's the key:

```{r sites, echo=FALSE}

print("Carnian")
cont_sites.car

print("Anisian")
cont_sites.an

```


## Al/Si

Al/Si is available from 2 Carnian sites and 1 Anisian site. Here I'm plotting the 
calibration dataset for the proxy (black) and the paleo-proxy values vs. the posterior median
site MAT (pink = Carnian, blue = Anisian).

```{r alsi, echo=FALSE}
plot(AlSi ~ MAT, data = alsi_cal, ylab = "Al/Si",
     xlim = range(c(as.data.frame(alsi_cal)$MAT, pm$t_cont.car[alsi_sites.ind.car],
                    pm$t_cont.an[alsi_sites.ind.an])),
     ylim = range(c(as.data.frame(alsi_cal)$AlSi, alsi_samples.car$AlSi,
                    alsi_samples.an$AlSi)))

points(pm$t_cont.car[alsi_sites.ind.car], alsi_samples.car$AlSi,
       col = col.c)

points(pm$t_cont.an[alsi_sites.ind.an], alsi_samples.an$AlSi,
       col = col.a)

text(pm$t_cont.car[alsi_sites.ind.car], par("usr")[4], alsi_sites.ind.car, 
     xpd = NA, pos = 3, col = col.c)

text(pm$t_cont.an[alsi_sites.ind.an], par("usr")[4], alsi_sites.ind.an, 
     xpd = NA, pos = 3, offset = 1.25, col = col.a)

```

A few things to note here.

* The data are very noisy.
* Depending on the site and stage, the posterior temperatures range from much cooler 
than the mean value you'd estimate from the proxy (top/left) to much warmer than 
you'd estimate from the proxy (bottom/right). The posterior MATs skew a little bit
cooler than you would get if you used these data alone, but are not too dissimilar
on average.
* That spread makes it clear that these data are not strongly pulling the MAT
reconstructions in one direction or another.

## CIA

Same thing for CIA, which is available at 3 Carnian and 2 Anisian sites.

```{r CIA, echo=FALSE}

plot(CIA ~ Temp, data = cia_cal, xlab = "MAT",
     xlim = range(c(as.data.frame(cia_cal)$Temp, pm$t_cont.car[cia_sites.ind.car],
                    pm$t_cont.an[cia_sites.ind.an])),
     ylim = range(c(as.data.frame(cia_cal)$CIA, cia_samples.car$CIA,
                    cia_samples.an$CIA)))

points(pm$t_cont.car[cia_sites.ind.car], cia_samples.car$CIA,
       col = col.c, pch = 20)

points(pm$t_cont.an[cia_sites.ind.an], cia_samples.an$CIA,
       col = col.a, pch = 20)

text(pm$t_cont.car[cia_sites.ind.car], par("usr")[4], cia_sites.ind.car, 
     xpd = NA, pos = 3, col = col.c)

text(pm$t_cont.an[cia_sites.ind.an], par("usr")[4], cia_sites.ind.an, 
     xpd = NA, pos = 3, offset = 1.25, col = col.a)

```

Similar situation.

* In this case, the posterior MATs tend to be a little higher than you'd expect
just based on the proxy data (top/right), with the opposite true for one 
Anisian site (bottom/left).
* It's a really weak proxy (huge scatter in the calibration data) so not 
surprising that here, too, there's not a a very strong influence on the MATs.

## PWI

Now paleosol weathering index, only available at two Carnian sites. I've added
the calibration curve using the median curve fit parameters in the posterior
for reference.

```{r PWI, echo=FALSE}

plot(PWI ~ MAT, data = pwi_cal, 
     xlim = range(c(as.data.frame(pwi_cal)$MAT, pm$t_cont.car[pwi_sites.ind.car])),
     ylim = range(c(as.data.frame(pwi_cal)$PWI, pwi_samples.car$PWI)))
xs = seq(par("usr")[1], par("usr")[2], length = 100)
ys = exp((xs + c(pm$pwi_a)) / c(pm$pwi_b))
lines(xs, ys)

points(pm$t_cont.car[pwi_sites.ind.car], pwi_samples.car$PWI,
       col = col.c, pch = 20)

text(pm$t_cont.car[pwi_sites.ind.car], par("usr")[4], pwi_sites.ind.car, 
     xpd = NA, pos = 3, col = col.c)

```

Here the reconstructions fit the calibration data well. Obviously the
interpretation is based on an extrapolation at site 3, but if one takes the
proxy at face value it's pretty tough for this site to have a MAT higher 
than, say, 5 or 10 $^\circ$. Note that this is the same site which has
a cool bias in the first plot (based on Al/Si).

## Clumped

Here I'm using the calibration function from Julia Kelson's paper, which is
represented as a line. Only one Anisian site.

```{r clumped, echo=FALSE}

plot(10:35, 6.36e4 / (10:35 + 273) ^ 2 + -4.7e-3, type = "l", 
     xlab = "MAT", ylab = expression(Delta*47),
     ylim = range(c(6.36e4 / (10:35 + 273) ^ 2 + -4.7e-3, 
                    clump_samples.an$cap_47)))

points(pm$t_cont.an[clump_sites.ind.an], clump_samples.an$cap_47,
       pch = 20, col = col.a)

points(pm$t_seas.an[clump_sites.ind.an], clump_samples.an$cap_47,
       col = col.a)

text(pm$t_cont.an[clump_sites.ind.an], par("usr")[4], clump_sites.ind.an, 
     xpd = NA, pos = 3, col = col.a)

```

* The JPI posterior is pretty much spot on after accounting for seasonality.
The closed symbols are MAT, the open ones are summer temperature.
* Note that this same site has a bunch of CIA data shown above, and the 
posterior MAT is at the warm side of the range that you'd predict based on the 
CIA data alone. The MAT at this site declined slightly when seasonality was
included, making the CIA results more congruent.

## Oxygen isotopes

I'm using carbonate $\delta$^18^O data from 2 Carnian and 4 Anisian sites. 
The lines on the plot show predicted average continental carbonate values as a 
function of temperature for the model prior (black) and posteriors (colors as 
throughout). This is derived in two steps:

* Precipitation $\delta$^18^O value is a function of temperature. The prior uses 
the classic modern empirical relationship. The slope and intercept of the 
relationship are model parameters which are sampled separately and optimized
for each stage.
* Carbonate $\delta$^18^O value is a function of the local precipitation 
$\delta$^18^O value and temperature. Previously we had been using MAT to 
describe fractionation in this step, which is reflected in the solid lines 
below. Now we're using summer season temperature. Because the relationship
between MAT and summer temperature is a function of both MAT and latitude we 
can't plot a single line representing this, but I've approximated the 
relationship by plotting the predicted carbonate $\delta$^18^O values using
summer season temperature for a site at 45$^\circ$ latitude (dotted lines).

The data are plotted as above, with the posterior median MAT on the x axis and
the measured proxy value on the y axis. 

```{r oxygen, echo=FALSE}

mat = 0:40
c_cont = -mat + 1.4836 - 0.2738 * 45
t_seas = (-0.9189 + sqrt(0.9189 ^ 2 - 4 * -0.0015 * c_cont)) /
      (2 * -0.0015)
d18O.prior = -14 + 0.59 * mat
d18Oc.prior = (d18O.prior + (2.78e6 / (mat + 273) ^ 2 + -2.98)) * 0.97002 - 29.98
d18Oc.prior.seas = (d18O.prior + (2.78e6 / (t_seas + 273) ^ 2 + -2.98)) * 0.97002 - 29.98

d18O.car.post = c(pm$d.car) + c(pm$e.car) * mat
d18Oc.car.post = (d18O.car.post + (2.78e6 / (mat + 273) ^ 2 + -2.98)) * 0.97002 - 29.98
d18Oc.car.post.seas = (d18O.car.post + (2.78e6 / (t_seas + 273) ^ 2 + -2.98)) * 0.97002 - 29.98

d18O.an.post = c(pm$d.an) + c(pm$e.an) * mat
d18Oc.an.post = (d18O.an.post + (2.78e6 / (mat + 273) ^ 2 + -2.98)) * 0.97002 - 29.98
d18Oc.an.post.seas = (d18O.an.post + (2.78e6 / (t_seas + 273) ^ 2 + -2.98)) * 0.97002 - 29.98

plot(mat, d18Oc.prior, type = "l", 
     ylim = range(c(d18Oc.prior, d18Oc.an.post, d18Oc.car.post,
                    pc_samples.car$d18O, pc_samples.an$d18O)),
     xlab = "MAT", ylab = expression(delta^{18}*"O paleosol carb"))
lines(mat, d18Oc.prior.seas, lty = 3)
lines(mat, d18Oc.car.post, col = col.c)
lines(mat, d18Oc.car.post.seas, col = col.c, lty = 3)
lines(mat, d18Oc.an.post, col = col.a)
lines(mat, d18Oc.an.post.seas, col = col.a, lty = 3)

points(pm$t_cont.car[pc_sites.ind.car], pc_samples.car$d18O, pch = 20, col = col.c)
points(pm$t_cont.an[pc_sites.ind.an], pc_samples.an$d18O, pch = 20, col = col.a)

text(pm$t_cont.car[pc_sites.ind.car], par("usr")[4], pc_sites.ind.car, 
     xpd = NA, pos = 3, col = col.c)

text(pm$t_cont.an[pc_sites.ind.an], par("usr")[4], pc_sites.ind.an, 
     xpd = NA, pos = 3, offset = 1.25, col = col.a)

```

The big take-home here is that terrestrial carbonate $\delta$^18^O values are 
low relative to the prior, especially at the warmer sites. This means that the
carbonate $\delta$^18^O data are 'pulling' the results toward lower MATs. This 
deviation is smaller if you account for seasonality.

Previously this deviation was mostly accommodated by the relationship between
MAT and precipitation $\delta$^18^O values, which was shifted toward lower
$\delta$^18^O values relative to the prior. You still see this here, but it
is much less severe than it used to be because using the warmer summer
temperatures for calcite formation account for several â€° of the 
deviation.

So using summer temperatures for calcite precipitation improves the fit between
the data and the posterior climate estimates overall. That said, it doesn't 
change the actually posterior climate estimates much at all...the improved fit
is in the form of either 1) the data better matching the model estimates (e.g., 
clumped), or 2) the posterior estimates of model parameters deviating less from
the priors (e.g., MAT - precipitation $\delta$^18^O relationship). So the same
comparative assessments largely stand:

* The cluster of 3 sites on the left of the plot are all sites where other
proxy data are available. Carnian 1 has CIA data, and the posterior
    + Carnian 1 (Los Rastros) has CIA data, and the posterior MAT is pretty much
    exactly what you'd predict based on the CIA values, suggesting that (to 
    some degree) the CIA data are confirming the MAT preferred given the 
    carbonate $\delta$^18^O data.
    + Carnian 4 (Ischigualasto) has PWI data, and, again, the MATs are a great 
    match to those data. You can see that for this site the $\delta$^18^O
    actually prefers slightly lower MAT relative to Los Rastros (and the prior
    estimate of site latitude is higher), but the PWI slightly out competes 
    those and pulls the MAT toward higher values.
    + Anisian 1 (Puntudo) has Al/Si data. For this one the Al/SI would prefer
    *much* lower MAT, and the influence of those data is probably why the 
    Anisian posterior $\delta$^18^O/MAT relationship is quite a bit lower than 
    that for the Carnian. 
* The 3 Anisian sites on the right of the plot are sites that have only
carbonate $\delta$^18^O data (no other proxies). You can see that the 
reconstructed MATs are biased warm (lower/right) relative even to the modeled
$\delta$^18^O/MAT relationship for the Anisian. This is almost certainly the
result of the meridional temperature gradient 'pulling' them toward warmer MATs.
For site 3 (Utah) this will be strongly influenced by the abundant low-latitude
marine proxy data. For the others, the fact that the prior on the meridional
MAT gradient is based on the modern, and having a much steeper gradient in
the Anisian comes at a probability cost, pulls the MATs at these sites toward
higher (lower gradient) temperatures. (Incidentally, it also pulls them toward
higher paleolatitudes...the posterior paleolatitudes for these sites are much
higher than the mean of the prior.)
